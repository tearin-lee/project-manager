<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê³ ê¸‰ í”„ë¡œì íŠ¸ ê´€ë¦¬ í…œí”Œë¦¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Noto Sans KR', 'sans-serif'],
                    },
                    colors: {
                        'project-not-started': '#d1d5db', // ì‘ì—…ì „ (Gray)
                        'project-in-progress': '#3b82f6', // ì‘ì—…ì¤‘ (Blue)
                        'project-revising': '#f59e0b',   // ìˆ˜ì •ì¤‘ (Amber)
                        'project-on-hold': '#6b7280',     // ë³´ë¥˜ (Gray)
                        'project-completed': '#10b981',   // ì™„ë£Œ (Emerald)
                    }
                },
            },
        };
    </script>
    <!-- Firebase SDKs -->
    <script type_module src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script type_module src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script type_module src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f3f4f6;
        }
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* ì»¤ìŠ¤í…€ ì²´í¬ë°•ìŠ¤ */
        .task-checkbox {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #cbd5e1;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            position: relative;
        }
        .task-checkbox:checked {
            background-color: #4f46e5;
            border-color: #4f46e5;
        }
        .task-checkbox:checked::after {
            content: '\u2713'; /* ì²´í¬ë§ˆí¬ */
            color: white;
            font-size: 14px;
            font-weight: bold;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .completed-task-text {
            text-decoration: line-through;
            color: #94a3b8;
        }
        /* ëª¨ë‹¬ */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal.flex { display: flex; } /* To show */
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 24px;
            border: 1px solid #888;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        /* í”„ë¡œê·¸ë ˆìŠ¤ ë°” */
        .progress-bar {
            background-color: #e5e7eb;
            border-radius: 999px;
            height: 8px;
            overflow: hidden;
        }
        .progress-bar-inner {
            background-color: #3b82f6;
            height: 100%;
            transition: width 0.3s ease;
        }
        /* íƒ­ ìŠ¤íƒ€ì¼ */
        .tab-btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .tab-btn.active {
            background-color: white;
            color: #4f46e5;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .tab-btn:not(.active):hover {
            background-color: #f0f0f5;
        }
        /* ìƒíƒœ ì…€ë ‰íŠ¸ ë°•ìŠ¤ */
        .status-select {
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            font-weight: 500;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='currentColor'%3e%3cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd' /%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1em 1em;
            padding-right: 2rem;
        }
    </style>
</head>
<body class="min-h-screen">

    <div id="loader" class="loader"></div>

    <!-- ì „ì²´ ì»¨í…Œì´ë„ˆ -->
    <div class="max-w-7xl mx-auto p-4 sm:p-8">

        <!-- í—¤ë” ë° íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <header class="mb-6 flex flex-col sm:flex-row justify-between items-center">
            <h1 class="text-3xl font-bold text-gray-900">ğŸš€ ê³ ê¸‰ í”„ë¡œì íŠ¸ ê´€ë¦¬ í…œí”Œë¦¿</h1>
            <div class="mt-4 sm:mt-0 p-1 bg-gray-200 rounded-lg flex gap-2">
                <button id="tab-dashboard" class="tab-btn active">âœ” Dashboard</button>
                <button id="tab-projects" class="tab-btn">ğŸ“Œ Projects</button>
            </div>
        </header>

        <!-- ======================= 1. ëŒ€ì‹œë³´ë“œ ë·° ======================= -->
        <div id="view-dashboard" class="space-y-6">
            <!-- ì˜¤ëŠ˜ ë‚ ì§œ ë° í†µê³„ -->
            <div class="p-6 bg-white rounded-2xl shadow-lg">
                <h2 class="text-2xl font-bold text-gray-800">ì˜¤ëŠ˜ì˜ ìš”ì•½</h2>
                <p id="dashboard-date" class="text-lg text-indigo-600 font-semibold"></p>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                    <div class="p-4 bg-blue-50 rounded-lg">
                        <div class="text-sm font-medium text-blue-600">ì´ í”„ë¡œì íŠ¸</div>
                        <div id="stat-total-projects" class="text-3xl font-bold text-blue-800">0</div>
                    </div>
                    <div class="p-4 bg-yellow-50 rounded-lg">
                        <div class="text-sm font-medium text-yellow-600">ì§„í–‰ ì¤‘</div>
                        <div id="stat-in-progress" class="text-3xl font-bold text-yellow-800">0</div>
                    </div>
                    <div class="p-4 bg-green-50 rounded-lg">
                        <div class="text-sm font-medium text-green-600">ì™„ë£Œ</div>
                        <div id="stat-completed" class="text-3xl font-bold text-green-800">0</div>
                    </div>
                </div>
            </div>

            <!-- ëˆ„ë½ ë°©ì§€ (ì˜¤ëŠ˜ í•  ì¼ & ë§ˆê° ì„ë°•) -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- ì˜¤ëŠ˜ í•´ì•¼ í•  ì‘ì—… -->
                <div class="p-6 bg-white rounded-2xl shadow-lg">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">â° ì˜¤ëŠ˜ê¹Œì§€!</h3>
                    <div id="dashboard-today-tasks" class="space-y-2">
                        <!-- íƒœìŠ¤í¬ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </div>
                </div>
                <!-- ë§ˆê° ì„ë°• ì‘ì—… -->
                <div class="p-6 bg-white rounded-2xl shadow-lg">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">ğŸ”¥ ë§ˆê° ì„ë°• (3ì¼ ì´ë‚´)</h3>
                    <div id="dashboard-due-soon-tasks" class="space-y-2">
                        <!-- íƒœìŠ¤í¬ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ======================= 2. í”„ë¡œì íŠ¸ ë·° ======================= -->
        <div id="view-projects" class="hidden space-y-4">
            <div class="flex justify-end">
                <button id="open-project-modal-btn" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-indigo-700 transition duration-200">
                    + ìƒˆ í”„ë¡œì íŠ¸ ì¶”ê°€
                </button>
            </div>
            <!-- í”„ë¡œì íŠ¸ ë¦¬ìŠ¤íŠ¸ (í…Œì´ë¸”) -->
            <div class="bg-white rounded-2xl shadow-lg overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">í”„ë¡œì íŠ¸ëª…</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">í´ë¼ì´ì–¸íŠ¸</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ìƒíƒœ</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì§„í–‰ë¥ </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ê¸°ê°„</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì‚°ì¶œë¬¼</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ì‚­ì œ</th>
                        </tr>
                    </thead>
                    <tbody id="project-list-body" class="bg-white divide-y divide-gray-200">
                        <!-- í”„ë¡œì íŠ¸ í–‰ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ======================= 3. íƒœìŠ¤í¬ ë·° ======================= -->
        <div id="view-tasks" class="hidden space-y-4">
            <!-- íƒœìŠ¤í¬ í—¤ë” -->
            <div class="flex justify-between items-center">
                <button id="back-to-projects-btn" class="text-indigo-600 font-semibold hover:underline">&larr; í”„ë¡œì íŠ¸ ëª©ë¡ìœ¼ë¡œ</button>
                <button id="open-task-modal-btn" class="bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg shadow hover:bg-indigo-700 transition duration-200">
                    + ìƒˆ íƒœìŠ¤í¬ ì¶”ê°€
                </button>
            </div>
            <div class="p-6 bg-white rounded-2xl shadow-lg">
                <h2 id="task-view-project-name" class="text-3xl font-bold text-gray-900 mb-2"></h2>
                <div id="task-view-progress-bar" class="progress-bar w-full">
                    <div id="task-view-progress-inner" class="progress-bar-inner" style="width: 0%;"></div>
                </div>
                <p id="task-view-progress-text" class="text-sm text-gray-600 mt-1 text-right font-medium">0% (0/0)</p>
            </div>
            
            <!-- íƒœìŠ¤í¬ ë¦¬ìŠ¤íŠ¸ -->
            <div id="task-list-container" class="space-y-3">
                <!-- íƒœìŠ¤í¬ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
        </div>

    </div> <!-- End Main Container -->

    <!-- ======================= ëª¨ë‹¬ ì„¹ì…˜ ======================= -->

    <!-- 1. ìƒˆ í”„ë¡œì íŠ¸ ëª¨ë‹¬ -->
    <div id="project-modal" class="modal">
        <div class="modal-content space-y-4">
            <h3 class="text-xl font-bold">ìƒˆ í”„ë¡œì íŠ¸</h3>
            <form id="project-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">í”„ë¡œì íŠ¸ëª…</label>
                    <input type="text" id="project-name" class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">í´ë¼ì´ì–¸íŠ¸</label>
                    <input type="text" id="project-client" class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">ìƒíƒœ</label>
                    <select id="project-status" class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2 bg-white">
                        <option value="ì‘ì—…ì „">ì‘ì—…ì „</option>
                        <option value="ì‘ì—…ì¤‘">ì‘ì—…ì¤‘</option>
                        <option value="ìˆ˜ì •ì¤‘">ìˆ˜ì •ì¤‘</option>
                        <option value="ë³´ë¥˜">ë³´ë¥˜</option>
                        <option value="ì™„ë£Œ">ì™„ë£Œ</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">ì‹œì‘ì¼</label>
                        <input type="date" id="project-start-date" class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">ë§ˆê°ì¼</label>
                        <input type="date" id="project-end-date" class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">ì‚°ì¶œë¬¼ (ë§í¬ ë“±)</label>
                    <input type="text" id="project-deliverables" class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2" placeholder="http://...">
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" id="close-project-modal-btn" class="bg-gray-200 px-4 py-2 rounded-lg font-medium">ì·¨ì†Œ</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-medium">ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 2. ìƒˆ íƒœìŠ¤í¬ ëª¨ë‹¬ -->
    <div id="task-modal" class="modal">
        <div class="modal-content space-y-4">
            <h3 class="text-xl font-bold">ìƒˆ íƒœìŠ¤í¬</h3>
            <form id="task-form" class="space-y-4">
                <input type="hidden" id="task-project-id">
                <div>
                    <label class="block text-sm font-medium text-gray-700">ì‘ì—…ëª…</label>
                    <input type="text" id="task-name" class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">ìš°ì„ ìˆœìœ„</label>
                        <select id="task-priority" class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2 bg-white">
                            <option value="ë‚®ìŒ">ë‚®ìŒ</option>
                            <option value="ë³´í†µ">ë³´í†µ</option>
                            <option value="ë†’ìŒ">ë†’ìŒ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">ë§ˆê°ì¼</label>
                        <input type="date" id="task-due-date" class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">ë¹„ê³ </label>
                    <textarea id="task-notes" rows="3" class="mt-1 block w-full border border-gray-300 rounded-lg px-3 py-2"></textarea>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" id="close-task-modal-btn" class="bg-gray-200 px-4 py-2 rounded-lg font-medium">ì·¨ì†Œ</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-medium">ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ë©”ì‹œì§€ ë°•ìŠ¤ -->
    <div id="message-box" style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #22c55e; color: white; padding: 10px 20px; border-radius: 8px; font-weight: 500; opacity: 0; transition: all 0.5s; visibility: hidden; z-index: 1000;"></div>

    <script type="module">
        // Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            collection, 
            addDoc, 
            setDoc,
            updateDoc,
            deleteDoc, 
            onSnapshot, 
            query,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase ì´ˆê¸°í™” ë° ì¸ì¦ ---
        
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, auth, db, userId;
        let projectsCollectionRef = null;
        let tasksCollectionRef = null;
        let unsubscribeProjects = null;
        let unsubscribeTasks = null;

        setLogLevel('Debug');

        // --- ê¸€ë¡œë²Œ ìƒíƒœ ---
        let projectsCache = [];
        let tasksCache = [];
        let currentView = 'dashboard'; // 'dashboard', 'projects', 'tasks'
        let currentProjectId = null;
        const statusColors = {
            'ì‘ì—…ì „': 'bg-project-not-started',
            'ì‘ì—…ì¤‘': 'bg-project-in-progress',
            'ìˆ˜ì •ì¤‘': 'bg-project-revising',
            'ë³´ë¥˜': 'bg-project-on-hold',
            'ì™„ë£Œ': 'bg-project-completed',
        };
        const priorityColors = {
            'ë‚®ìŒ': 'bg-gray-100 text-gray-800',
            'ë³´í†µ': 'bg-blue-100 text-blue-800',
            'ë†’ìŒ': 'bg-red-100 text-red-800',
        };

        // --- UI ìš”ì†Œ ---
        const loader = document.getElementById('loader');
        const messageBox = document.getElementById('message-box');

        const tabDashboard = document.getElementById('tab-dashboard');
        const tabProjects = document.getElementById('tab-projects');
        
        const viewDashboard = document.getElementById('view-dashboard');
        const viewProjects = document.getElementById('view-projects');
        const viewTasks = document.getElementById('view-tasks');

        // ëŒ€ì‹œë³´ë“œ
        const dashboardDate = document.getElementById('dashboard-date');
        const statTotalProjects = document.getElementById('stat-total-projects');
        const statInProgress = document.getElementById('stat-in-progress');
        const statCompleted = document.getElementById('stat-completed');
        const dashboardTodayTasks = document.getElementById('dashboard-today-tasks');
        const dashboardDueSoonTasks = document.getElementById('dashboard-due-soon-tasks');

        // í”„ë¡œì íŠ¸
        const openProjectModalBtn = document.getElementById('open-project-modal-btn');
        const projectModal = document.getElementById('project-modal');
        const projectForm = document.getElementById('project-form');
        const closeProjectModalBtn = document.getElementById('close-project-modal-btn');
        const projectListBody = document.getElementById('project-list-body');

        // íƒœìŠ¤í¬
        const backToProjectsBtn = document.getElementById('back-to-projects-btn');
        const openTaskModalBtn = document.getElementById('open-task-modal-btn');
        const taskModal = document.getElementById('task-modal');
        const taskForm = document.getElementById('task-form');
        const closeTaskModalBtn = document.getElementById('close-task-modal-btn');
        const taskProjectIdInput = document.getElementById('task-project-id');
        const taskViewProjectName = document.getElementById('task-view-project-name');
        const taskViewProgressBar = document.getElementById('task-view-progress-bar');
        const taskViewProgressInner = document.getElementById('task-view-progress-inner');
        const taskViewProgressText = document.getElementById('task-view-progress-text');
        const taskListContainer = document.getElementById('task-list-container');
        
        // --- í—¬í¼ í•¨ìˆ˜ ---
        
        function showMessage(message, isSuccess = true) {
            messageBox.textContent = message;
            messageBox.style.backgroundColor = isSuccess ? '#22c55e' : '#ef4444';
            messageBox.style.opacity = '1';
            messageBox.style.visibility = 'visible';
            setTimeout(() => {
                messageBox.style.opacity = '0';
                messageBox.style.visibility = 'hidden';
            }, 3000);
        }

        function getTodayString() {
            const today = new Date();
            return today.toISOString().split('T')[0];
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('ko-KR', { year: 'numeric', month: '2-digit', day: '2-digit' });
        }

        // --- ë·° ì „í™˜ ë¡œì§ ---
        function switchView(view) {
            currentView = view;
            
            // ëª¨ë“  ë·° ìˆ¨ê¸°ê¸°
            viewDashboard.classList.add('hidden');
            viewProjects.classList.add('hidden');
            viewTasks.classList.add('hidden');
            
            // íƒ­ ë¹„í™œì„±í™”
            tabDashboard.classList.remove('active');
            tabProjects.classList.remove('active');

            if (view === 'dashboard') {
                viewDashboard.classList.remove('hidden');
                tabDashboard.classList.add('active');
                renderDashboard();
            } else if (view === 'projects') {
                viewProjects.classList.remove('hidden');
                tabProjects.classList.add('active');
                renderProjects();
            } else if (view === 'tasks') {
                viewTasks.classList.remove('hidden');
                // íƒœìŠ¤í¬ ë·°ëŠ” íƒ­ì´ ì•„ë‹˜ (í•˜ìœ„ ë·°)
                tabProjects.classList.add('active'); // ë¶€ëª¨ì¸ í”„ë¡œì íŠ¸ íƒ­ì„ í™œì„±í™”
                renderTasksView();
            }
        }

        // --- ë Œë”ë§ í•¨ìˆ˜ ---

        // 1. ëŒ€ì‹œë³´ë“œ ë Œë”ë§
        function renderDashboard() {
            // ì˜¤ëŠ˜ ë‚ ì§œ
            const today = new Date();
            dashboardDate.textContent = today.toLocaleDateString('ko-KR', {
                year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'
            });

            // í†µê³„
            const total = projectsCache.length;
            const inProgress = projectsCache.filter(p => p.status === 'ì‘ì—…ì¤‘' || p.status === 'ìˆ˜ì •ì¤‘').length;
            const completed = projectsCache.filter(p => p.status === 'ì™„ë£Œ').length;
            statTotalProjects.textContent = total;
            statInProgress.textContent = inProgress;
            statCompleted.textContent = completed;

            // íƒœìŠ¤í¬ í•„í„°ë§
            const todayStr = getTodayString();
            const threeDaysLater = new Date(today.getTime() + 3 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];

            const todayTasks = tasksCache.filter(t => t.dueDate === todayStr && !t.completed);
            const dueSoonTasks = tasksCache.filter(t => 
                t.dueDate > todayStr && 
                t.dueDate <= threeDaysLater && 
                !t.completed
            );

            // ì˜¤ëŠ˜ í•  ì¼ ë Œë”ë§
            dashboardTodayTasks.innerHTML = '';
            if (todayTasks.length === 0) {
                dashboardTodayTasks.innerHTML = '<p class="text-gray-500">ì˜¤ëŠ˜ ë§ˆê°ì¸ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤. í›Œë¥­í•´ìš”!</p>';
            } else {
                todayTasks.forEach(task => {
                    const project = projectsCache.find(p => p.id === task.projectId);
                    dashboardTodayTasks.appendChild(createDashboardTaskElement(task, project));
                });
            }

            // ë§ˆê° ì„ë°• ë Œë”ë§
            dashboardDueSoonTasks.innerHTML = '';
            if (dueSoonTasks.length === 0) {
                dashboardDueSoonTasks.innerHTML = '<p class="text-gray-500">ë§ˆê° ì„ë°• ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            } else {
                dueSoonTasks.forEach(task => {
                    const project = projectsCache.find(p => p.id === task.projectId);
                    dashboardDueSoonTasks.appendChild(createDashboardTaskElement(task, project));
                });
            }
        }

        function createDashboardTaskElement(task, project) {
            const el = document.createElement('div');
            el.className = 'p-3 bg-gray-50 rounded-lg flex justify-between items-center';
            el.innerHTML = `
                <div>
                    <span class="font-medium">${task.name}</span>
                    <span class="text-sm text-gray-500 ml-2">(${project ? project.name : 'ì•Œ ìˆ˜ ì—†ìŒ'})</span>
                </div>
                <span class="text-sm font-semibold text-red-600">${formatDate(task.dueDate)}</span>
            `;
            return el;
        }

        // 2. í”„ë¡œì íŠ¸ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
        function renderProjects() {
            projectListBody.innerHTML = ''; // ëª©ë¡ ë¹„ìš°ê¸°
            
            const sortedProjects = [...projectsCache].sort((a, b) => {
                // ì™„ë£Œëœ í”„ë¡œì íŠ¸ë¥¼ ë§¨ ë’¤ë¡œ
                if (a.status === 'ì™„ë£Œ' && b.status !== 'ì™„ë£Œ') return 1;
                if (a.status !== 'ì™„ë£Œ' && b.status === 'ì™„ë£Œ') return -1;
                // ë§ˆê°ì¼ ìˆœ ì •ë ¬
                if (a.endDate && b.endDate) return new Date(a.endDate) - new Date(b.endDate);
                if (a.endDate) return -1;
                if (b.endDate) return 1;
                return 0;
            });

            if (sortedProjects.length === 0) {
                projectListBody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500 py-10">í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆ í”„ë¡œì íŠ¸ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”.</td></tr>';
                return;
            }

            sortedProjects.forEach(project => {
                // ì§„í–‰ë¥  ê³„ì‚°
                const projectTasks = tasksCache.filter(t => t.projectId === project.id);
                const completedTasks = projectTasks.filter(t => t.completed).length;
                const totalTasks = projectTasks.length;
                const progress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition";
                
                const statusColor = statusColors[project.status] || 'bg-gray-300';

                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <a href="#" data-projectid="${project.id}" class="project-link text-lg font-semibold text-indigo-600 hover:underline">${project.name}</a>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${project.client || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <select class="status-select text-sm ${statusColor} text-white" data-projectid="${project.id}">
                            ${Object.keys(statusColors).map(status => `
                                <option value="${status}" ${project.status === status ? 'selected' : ''}>${status}</option>
                            `).join('')}
                        </select>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${progress}%</div>
                        <div class="progress-bar w-24">
                            <div class="progress-bar-inner" style="width: ${progress}%;"></div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                        ${formatDate(project.startDate)} ~ ${formatDate(project.endDate)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        ${project.deliverables ? `<a href="${project.deliverables}" target="_blank" class="text-indigo-600 hover:underline">ë§í¬</a>` : '-'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="delete-project-btn text-red-500 hover:text-red-700" data-projectid="${project.id}">&times; ì‚­ì œ</button>
                    </td>
                `;
                projectListBody.appendChild(tr);
            });

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë°”ì¸ë”©
            projectListBody.querySelectorAll('.project-link').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    currentProjectId = e.target.dataset.projectid;
                    switchView('tasks');
                });
            });

            projectListBody.querySelectorAll('.status-select').forEach(select => {
                select.addEventListener('change', (e) => {
                    updateProjectStatus(e.target.dataset.projectid, e.target.value);
                });
            });

            projectListBody.querySelectorAll('.delete-project-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    // confirm()ì€ ìº”ë²„ìŠ¤ í™˜ê²½ì—ì„œ ì‘ë™í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ê°„ë‹¨íˆ ì‚­ì œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
                    // ì‹¤ì œ ì•±ì—ì„œëŠ” ì»¤ìŠ¤í…€ í™•ì¸ ëª¨ë‹¬ì„ ë„ì›Œì•¼ í•©ë‹ˆë‹¤.
                    deleteProject(e.target.dataset.projectid);
                });
            });
        }
        
        // 3. íƒœìŠ¤í¬ ë·° ë Œë”ë§
        function renderTasksView() {
            if (!currentProjectId) {
                switchView('projects');
                return;
            }

            const project = projectsCache.find(p => p.id === currentProjectId);
            if (!project) {
                showMessage("í”„ë¡œì íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", false);
                switchView('projects');
                return;
            }

            taskViewProjectName.textContent = project.name;

            const projectTasks = tasksCache
                .filter(t => t.projectId === currentProjectId)
                .sort((a, b) => {
                    // 1. ì™„ë£Œ ì—¬ë¶€
                    if (a.completed !== b.completed) return a.completed ? 1 : -1;
                    // 2. ë§ˆê°ì¼
                    if (a.dueDate && b.dueDate) return new Date(a.dueDate) - new Date(b.dueDate);
                    if (a.dueDate) return -1;
                    if (b.dueDate) return 1;
                    // 3. ìš°ì„ ìˆœìœ„ (ë†’ìŒ > ë³´í†µ > ë‚®ìŒ)
                    const prio = { 'ë†’ìŒ': 1, 'ë³´í†µ': 2, 'ë‚®ìŒ': 3 };
                    if (prio[a.priority] !== prio[b.priority]) return prio[a.priority] - prio[b.priority];
                    return 0;
                });

            // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
            const completedTasks = projectTasks.filter(t => t.completed).length;
            const totalTasks = projectTasks.length;
            const progress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            taskViewProgressInner.style.width = `${progress}%`;
            taskViewProgressText.textContent = `${progress}% (${completedTasks}/${totalTasks})`;

            // íƒœìŠ¤í¬ ëª©ë¡ ë Œë”ë§
            taskListContainer.innerHTML = '';
            if (projectTasks.length === 0) {
                taskListContainer.innerHTML = '<p class="text-center text-gray-500 py-10">íƒœìŠ¤í¬ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆ íƒœìŠ¤í¬ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”.</p>';
                return;
            }

            projectTasks.forEach(task => {
                taskListContainer.appendChild(createTaskElement(task));
            });
        }

        function createTaskElement(task) {
            const el = document.createElement('div');
            el.className = `task-item flex items-start gap-3 p-4 rounded-lg shadow-sm transition-all duration-200 ${task.completed ? 'bg-gray-100 opacity-70' : 'bg-white'}`;
            el.dataset.id = task.id;

            const prioColor = priorityColors[task.priority] || 'bg-gray-100 text-gray-800';
            const dueDateStr = formatDate(task.dueDate);
            const isOverdue = task.dueDate && getTodayString() > task.dueDate && !task.completed;

            el.innerHTML = `
                <input type="checkbox" class="task-checkbox mt-1" ${task.completed ? 'checked' : ''}>
                <div class="flex-grow">
                    <input type="text" value="${task.name}" class="task-name-input font-medium text-gray-800 w-full bg-transparent border-none p-0 outline-none ${task.completed ? 'completed-task-text' : ''}">
                    <p class="text-sm text-gray-500 mt-1">${task.notes || ''}</p>
                </div>
                <div class="flex-shrink-0 flex flex-col items-end gap-1 text-sm">
                    <span class="px-2 py-0.5 rounded-full font-semibold text-xs ${prioColor}">${task.priority}</span>
                    <span class_="${isOverdue ? 'text-red-600 font-bold' : 'text-gray-600'}">${dueDateStr}</span>
                    <button class="delete-task-btn text-gray-400 hover:text-red-500 text-xl font-bold">&times;</button>
                </div>
            `;

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            el.querySelector('.task-checkbox').addEventListener('change', (e) => {
                updateTask(task.id, { completed: e.target.checked });
            });
            el.querySelector('.task-name-input').addEventListener('blur', (e) => {
                if (e.target.value.trim() !== task.name) {
                    updateTask(task.id, { name: e.target.value.trim() });
                }
            });
            el.querySelector('.delete-task-btn').addEventListener('click', () => {
                deleteTask(task.id);
            });

            return el;
        }

        // --- Firebase ë°ì´í„° ë¡œë“œ (ì‹¤ì‹œê°„) ---
        
        function initApp(uid) {
            userId = uid;
            projectsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/projects`);
            tasksCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/tasks`);
            
            loadProjects();
            loadTasks();
        }

        function loadProjects() {
            if (unsubscribeProjects) unsubscribeProjects();
            loader.style.display = 'block';

            unsubscribeProjects = onSnapshot(query(projectsCollectionRef), (snapshot) => {
                projectsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Projects loaded:", projectsCache.length);
                if (currentView === 'dashboard') renderDashboard();
                if (currentView === 'projects') renderProjects();
                if (currentView === 'tasks') renderTasksView(); // For progress update
                loader.style.display = 'none';
            }, (error) => {
                console.error("í”„ë¡œì íŠ¸ ë¡œë“œ ì˜¤ë¥˜:", error);
                showMessage("í”„ë¡œì íŠ¸ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", false);
                loader.style.display = 'none';
            });
        }

        function loadTasks() {
            if (unsubscribeTasks) unsubscribeTasks();
            
            unsubscribeTasks = onSnapshot(query(tasksCollectionRef), (snapshot) => {
                tasksCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Tasks loaded:", tasksCache.length);
                if (currentView === 'dashboard') renderDashboard();
                if (currentView === 'projects') renderProjects(); // For progress update
                if (currentView === 'tasks') renderTasksView();
            }, (error) => {
                console.error("íƒœìŠ¤í¬ ë¡œë“œ ì˜¤ë¥˜:", error);
                showMessage("íƒœìŠ¤í¬ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", false);
            });
        }
        
        // --- Firebase CRUD ì‘ì—… ---

        // í”„ë¡œì íŠ¸
        async function handleProjectFormSubmit(e) {
            e.preventDefault();
            const project = {
                name: document.getElementById('project-name').value,
                client: document.getElementById('project-client').value,
                status: document.getElementById('project-status').value,
                startDate: document.getElementById('project-start-date').value,
                endDate: document.getElementById('project-end-date').value,
                deliverables: document.getElementById('project-deliverables').value,
                createdAt: new Date().getTime(),
            };

            try {
                await addDoc(projectsCollectionRef, project);
                showMessage("í”„ë¡œì íŠ¸ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
                projectForm.reset();
                projectModal.classList.remove('flex');
            } catch (error) {
                console.error("í”„ë¡œì íŠ¸ ì¶”ê°€ ì˜¤ë¥˜:", error);
                showMessage("í”„ë¡œì íŠ¸ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", false);
            }
        }

        async function updateProjectStatus(id, status) {
            const projectRef = doc(db, projectsCollectionRef.path, id);
            try {
                await updateDoc(projectRef, { status: status });
                showMessage("ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
                // onSnapshotì´ UIë¥¼ ê°±ì‹ 
            } catch (error) {
                console.error("ìƒíƒœ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:", error);
                showMessage("ìƒíƒœ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", false);
            }
        }

        async function deleteProject(id) {
            // TODO: ê´€ë ¨ íƒœìŠ¤í¬ë„ í•¨ê»˜ ì‚­ì œí•˜ëŠ” ë¡œì§ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            // ì—¬ê¸°ì„œëŠ” ì¼ë‹¨ í”„ë¡œì íŠ¸ë§Œ ì‚­ì œí•©ë‹ˆë‹¤.
            const projectRef = doc(db, projectsCollectionRef.path, id);
            try {
                await deleteDoc(projectRef);
                showMessage("í”„ë¡œì íŠ¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                // onSnapshotì´ UIë¥¼ ê°±ì‹ 
            } catch (error) {
                console.error("í”„ë¡œì íŠ¸ ì‚­ì œ ì˜¤ë¥˜:", error);
                showMessage("í”„ë¡œì íŠ¸ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", false);
            }
        }

        // íƒœìŠ¤í¬
        async function handleTaskFormSubmit(e) {
            e.preventDefault();
            const task = {
                projectId: taskProjectIdInput.value,
                name: document.getElementById('task-name').value,
                priority: document.getElementById('task-priority').value,
                dueDate: document.getElementById('task-due-date').value,
                notes: document.getElementById('task-notes').value,
                completed: false,
                createdAt: new Date().getTime(),
            };

            try {
                await addDoc(tasksCollectionRef, task);
                showMessage("íƒœìŠ¤í¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
                taskForm.reset();
                taskModal.classList.remove('flex');
            } catch (error) {
                console.error("íƒœìŠ¤í¬ ì¶”ê°€ ì˜¤ë¥˜:", error);
                showMessage("íƒœìŠ¤í¬ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", false);
            }
        }

        async function updateTask(id, data) {
            const taskRef = doc(db, tasksCollectionRef.path, id);
            try {
                await updateDoc(taskRef, data);
                showMessage("íƒœìŠ¤í¬ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } catch (error) {
                console.error("íƒœìŠ¤í¬ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:", error);
                showMessage("íƒœìŠ¤í¬ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", false);
            }
        }
        
        async function deleteTask(id) {
            const taskRef = doc(db, tasksCollectionRef.path, id);
            try {
                await deleteDoc(taskRef);
                showMessage("íƒœìŠ¤í¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            } catch (error) {
                console.error("íƒœìŠ¤í¬ ì‚­ì œ ì˜¤ë¥˜:", error);
                showMessage("íƒœìŠ¤í¬ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", false);
            }
        }
        
        // --- ì¸ì¦ ë° ì•± ì‹œì‘ ---
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log("ì¸ì¦ ì„±ê³µ! User ID:", user.uid);
                        initApp(user.uid);
                    } else {
                        console.log("ì¸ì¦ëœ ì‚¬ìš©ì ì—†ìŒ. ìµëª… ë¡œê·¸ì¸ ì‹œë„...");
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });

            } catch (error) {
                console.error("Firebase ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
                loader.style.display = 'none';
                showMessage("ì•± ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", false);
            }
        }

        // --- ì´ˆê¸° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ---
        
        // íƒ­
        tabDashboard.addEventListener('click', () => switchView('dashboard'));
        tabProjects.addEventListener('click', () => switchView('projects'));
        
        // í”„ë¡œì íŠ¸ ëª¨ë‹¬
        openProjectModalBtn.addEventListener('click', () => projectModal.classList.add('flex'));
        closeProjectModalBtn.addEventListener('click', () => projectModal.classList.remove('flex'));
        projectForm.addEventListener('submit', handleProjectFormSubmit);
        
        // íƒœìŠ¤í¬ ëª¨ë‹¬
        openTaskModalBtn.addEventListener('click', () => {
            taskProjectIdInput.value = currentProjectId;
            taskModal.classList.add('flex');
        });
        closeTaskModalBtn.addEventListener('click', () => taskModal.classList.remove('flex'));
        taskForm.addEventListener('submit', handleTaskFormSubmit);

        // íƒœìŠ¤í¬ ë·° -> í”„ë¡œì íŠ¸ ë·°
        backToProjectsBtn.addEventListener('click', () => switchView('projects'));
        
        // --- ì•± ì‹œì‘ ---
        initializeFirebase();
        switchView('dashboard'); // ì´ˆê¸° ë·° ì„¤ì •

    </script>
</body>
</html>
